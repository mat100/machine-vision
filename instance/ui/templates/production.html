<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Mode - {{ config.name }}</title>
    
    <!-- Tailwind CSS -->
    <script src="/static/lib/tailwind.min.js"></script>
    
    <!-- HTMX -->
    <script src="/static/lib/htmx.min.js"></script>
    
    <!-- Alpine.js -->
    <script defer src="/static/lib/alpine.min.js"></script>
    
    <!-- Chart.js -->
    <script src="/static/lib/chart.min.js"></script>
    
    <style>
        [x-cloak] { display: none !important; }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-running { background-color: #10b981; }
        .status-stopped { background-color: #ef4444; }
        .status-warning { background-color: #f59e0b; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen" x-data="productionApp()">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <h1 class="text-xl font-semibold text-gray-900">{{ config.name }}</h1>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="/" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Dashboard
                        </a>
                        <a href="/data-collection" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Data Collection
                        </a>
                        <a href="/sorting" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Sorting
                        </a>
                        <a href="/training" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Training
                        </a>
                        <a href="/production" class="border-blue-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Production
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            <!-- Header -->
            <div class="mb-8">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Production Mode</h1>
                        <p class="mt-2 text-gray-600">Real-time classification and monitoring</p>
                    </div>
                    <div class="flex space-x-3">
                        <button 
                            @click="startProduction()" 
                            :disabled="productionStatus.production_mode || !productionStatus.active_model"
                            class="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-md text-sm font-medium">
                            Start Production
                        </button>
                        <button 
                            @click="stopProduction()" 
                            :disabled="!productionStatus.production_mode"
                            class="bg-red-600 hover:bg-red-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-md text-sm font-medium">
                            Stop Production
                        </button>
                    </div>
                </div>
            </div>

            <!-- Alert for no active model -->
            <div x-show="!productionStatus.active_model" class="mb-6 bg-yellow-50 border border-yellow-200 rounded-md p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-yellow-800">No Active Model</h3>
                        <div class="mt-2 text-sm text-yellow-700">
                            <p>You need to train and activate a model before starting production mode.</p>
                            <p class="mt-1">
                                <a href="/training" class="font-medium underline hover:text-yellow-600">Go to Training Page</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alert for restored state -->
            <div x-show="showRestoredAlert" class="mb-6 bg-green-50 border border-green-200 rounded-md p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-green-800">Production Mode Restored</h3>
                        <div class="mt-2 text-sm text-green-700">
                            <p>Production mode was automatically restored from the previous session.</p>
                        </div>
                    </div>
                    <div class="ml-auto pl-3">
                        <div class="-mx-1.5 -my-1.5">
                            <button @click="showRestoredAlert = false" class="inline-flex bg-green-50 rounded-md p-1.5 text-green-500 hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-green-50 focus:ring-green-600">
                                <span class="sr-only">Dismiss</span>
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Production Status -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- Status Card -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="status-indicator" :class="productionStatus.production_mode ? 'status-running' : 'status-stopped'"></div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Production Status</dt>
                                    <dd class="text-lg font-medium text-gray-900" x-text="productionStatus.production_mode ? 'Running' : 'Stopped'"></dd>
                                </dl>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-500">Active Model: <span class="font-medium" x-text="productionStatus.active_model || 'None'"></span></p>
                            <p class="text-sm text-gray-500">Queue Size: <span class="font-medium" x-text="productionStatus.queue_size"></span></p>
                            <p class="text-sm text-gray-500">Camera ID: <span class="font-medium">0</span></p>
                        </div>
                    </div>
                </div>

                <!-- Processing Stats -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-6 w-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Processing Stats</dt>
                                    <dd class="text-lg font-medium text-gray-900" x-text="productionStatus.stats.total_processed"></dd>
                                </dl>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-500">Success Rate: <span class="font-medium" x-text="getSuccessRate() + '%'"></span></p>
                            <p class="text-sm text-gray-500">Avg Time: <span class="font-medium" x-text="productionStatus.stats.average_processing_time.toFixed(2) + 's'"></span></p>
                        </div>
                    </div>
                </div>

                <!-- Confidence Distribution -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-6 w-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Confidence</dt>
                                    <dd class="text-lg font-medium text-gray-900">Distribution</dd>
                                </dl>
                            </div>
                        </div>
                        <div class="mt-4 space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-green-600">High (≥90%)</span>
                                <span class="font-medium" x-text="productionStatus.stats.confidence_distribution.high"></span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-yellow-600">Medium (70-89%)</span>
                                <span class="font-medium" x-text="productionStatus.stats.confidence_distribution.medium"></span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-red-600">Low (<70%)</span>
                                <span class="font-medium" x-text="productionStatus.stats.confidence_distribution.low"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings and Controls -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Production Settings -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Production Settings</h3>
                        <form @submit.prevent="updateSettings()" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Confidence Threshold</label>
                                <input 
                                    type="range" 
                                    min="0.5" 
                                    max="1.0" 
                                    step="0.05" 
                                    x-model="settings.confidence_threshold"
                                    class="w-full mt-1"
                                >
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>50%</span>
                                    <span x-text="(settings.confidence_threshold * 100).toFixed(0) + '%'"></span>
                                    <span>100%</span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Max Processing Time (seconds)</label>
                                <input 
                                    type="number" 
                                    x-model="settings.max_processing_time"
                                    min="1" 
                                    max="30" 
                                    step="0.5"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                >
                            </div>
                            
                            <div class="flex items-center">
                                <input 
                                    type="checkbox" 
                                    x-model="settings.save_results"
                                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                >
                                <label class="ml-2 block text-sm text-gray-900">Save Results</label>
                            </div>
                            
                            <div class="flex items-center">
                                <input 
                                    type="checkbox" 
                                    x-model="settings.enable_logging"
                                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                >
                                <label class="ml-2 block text-sm text-gray-900">Enable Logging</label>
                            </div>
                            
                            <button 
                                type="submit" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                                Update Settings
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Quick Actions</h3>
                        <div class="space-y-3">
                            <button 
                                @click="captureAndClassify()"
                                :disabled="!productionStatus.production_mode"
                                class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-md text-sm font-medium">
                                Capture & Classify
                            </button>
                            
                            <button 
                                @click="resetStats()"
                                class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                                Reset Statistics
                            </button>
                            
                            <button 
                                @click="refreshStatus()"
                                class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                                Refresh Status
                            </button>
                        </div>
                        
                        <div class="mt-6 p-4 bg-gray-50 rounded-md">
                            <h4 class="text-sm font-medium text-gray-900 mb-2">System Info</h4>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p>Start Time: <span x-text="getStartTime()"></span></p>
                                <p>Last Processed: <span x-text="getLastProcessed()"></span></p>
                                <p>Uptime: <span x-text="getUptime()"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Results -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Recent Results</h3>
                        <button 
                            @click="loadResults()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-sm font-medium">
                            Refresh
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Confidence</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Processing Time</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="result in recentResults" :key="result.timestamp">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatTimestamp(result.timestamp)"></td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full" 
                                                  :class="getClassBadgeClass(result.class_name)"
                                                  x-text="result.class_name"></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            <span x-text="(result.confidence * 100).toFixed(1) + '%'"></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="result.processing_time.toFixed(2) + 's'"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <a :href="'/images/' + result.image_path.split('/').pop()" target="_blank" class="text-blue-600 hover:text-blue-900">View</a>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    
                    <div x-show="recentResults.length === 0" class="text-center py-8 text-gray-500">
                        No results available
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        function productionApp() {
            return {
                productionStatus: {
                    production_mode: false,
                    active_model: null,
                    settings: {},
                    stats: {
                        total_processed: 0,
                        successful_classifications: 0,
                        failed_classifications: 0,
                        average_processing_time: 0,
                        confidence_distribution: { high: 0, medium: 0, low: 0 }
                    },
                    queue_size: 0
                },
                settings: {
                    confidence_threshold: 0.8,
                    max_processing_time: 5.0,
                    save_results: true,
                    enable_logging: true
                },
                recentResults: [],
                showRestoredAlert: false,
                
                async init() {
                    await this.loadStatus();
                    this.loadSettings();
                    await this.loadResults();
                    
                    // Auto-refresh every 5 seconds
                    setInterval(async () => {
                        if (this.productionStatus.production_mode) {
                            await this.loadStatus();
                            await this.loadResults();
                        }
                    }, 5000);
                    
                    // Check if production mode was restored (this will be handled in loadStatus now)
                    setTimeout(() => {
                        if (this.productionStatus.production_mode) {
                            console.log('Production mode restored from saved state');
                        }
                    }, 1000);
                },
                
                async loadStatus() {
                    try {
                        const response = await fetch('/api/production/status');
                        const data = await response.json();
                        
                        // Check if this is the first load and production mode was restored
                        const wasProductionMode = this.productionStatus.production_mode;
                        this.productionStatus = data;
                        
                        // Show restored alert only on first load when production mode is running
                        if (!wasProductionMode && this.productionStatus.production_mode && this.productionStatus.instance_state?.production_mode) {
                            this.showRestoredAlert = true;
                        }
                        
                        console.log('Loaded production status:', data);
                    } catch (error) {
                        console.error('Error loading production status:', error);
                    }
                },
                
                async loadSettings() {
                    // Load settings from production status, with fallback to defaults
                    const defaultSettings = {
                        confidence_threshold: 0.8,
                        max_processing_time: 5.0,
                        save_results: true,
                        enable_logging: true
                    };
                    
                    this.settings = {
                        ...defaultSettings,
                        ...this.productionStatus.settings
                    };
                    
                    console.log('Loaded settings:', this.settings);
                    console.log('Production status settings:', this.productionStatus.settings);
                },
                
                async loadResults() {
                    try {
                        const response = await fetch('/api/production/results?limit=20');
                        const data = await response.json();
                        this.recentResults = data.results;
                    } catch (error) {
                        console.error('Error loading results:', error);
                    }
                },
                
                async startProduction() {
                    try {
                        const response = await fetch('/api/production/start', { method: 'POST' });
                        const data = await response.json();
                        if (data.success) {
                            this.loadStatus();
                        } else {
                            alert('Failed to start production mode');
                        }
                    } catch (error) {
                        console.error('Error starting production:', error);
                        alert('Error starting production mode');
                    }
                },
                
                async stopProduction() {
                    try {
                        const response = await fetch('/api/production/stop', { method: 'POST' });
                        const data = await response.json();
                        if (data.success) {
                            this.loadStatus();
                        } else {
                            alert('Failed to stop production mode');
                        }
                    } catch (error) {
                        console.error('Error stopping production:', error);
                        alert('Error stopping production mode');
                    }
                },
                
                async updateSettings() {
                    try {
                        const response = await fetch('/api/production/settings', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.settings)
                        });
                        const data = await response.json();
                        if (data.success) {
                            await this.loadStatus();
                            this.loadSettings(); // Reload settings to ensure consistency
                        } else {
                            alert('Failed to update settings');
                        }
                    } catch (error) {
                        console.error('Error updating settings:', error);
                        alert('Error updating settings');
                    }
                },
                
                async captureAndClassify() {
                    try {
                        const response = await fetch('/api/production/capture-and-classify', { method: 'POST' });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || 'Failed to capture and classify image');
                        }
                        const data = await response.json();
                        if (data.success && data.result && data.result.class_name) {
                            // Update statistics and results
                            await this.loadResults();
                            await this.loadStatus();
                            
                            // Force update statistics
                            try {
                                await fetch('/api/production/update-stats', { method: 'POST' });
                            } catch (e) {
                                console.warn('Could not update stats:', e);
                            }
                            
                            alert(`Successfully classified as: ${data.result.class_name} (${(data.result.confidence * 100).toFixed(1)}%)`);
                        } else {
                            throw new Error('Classification failed - no result returned');
                        }
                    } catch (error) {
                        console.error('Error capturing and classifying:', error);
                        alert('Error: ' + error.message);
                    }
                },
                
                async resetStats() {
                    if (confirm('Are you sure you want to reset all production statistics?')) {
                        try {
                            const response = await fetch('/api/production/reset-stats', { method: 'POST' });
                            const data = await response.json();
                            if (data.success) {
                                this.loadStatus();
                            } else {
                                alert('Failed to reset statistics');
                            }
                        } catch (error) {
                            console.error('Error resetting stats:', error);
                            alert('Error resetting statistics');
                        }
                    }
                },
                
                async refreshStatus() {
                    this.loadStatus();
                    this.loadResults();
                },
                
                getSuccessRate() {
                    const total = this.productionStatus.stats.total_processed;
                    const successful = this.productionStatus.stats.successful_classifications;
                    return total > 0 ? Math.round((successful / total) * 100) : 0;
                },
                
                getClassBadgeClass(className) {
                    if (className === 'OK') return 'bg-green-100 text-green-800';
                    if (className === 'NG') return 'bg-red-100 text-red-800';
                    return 'bg-gray-100 text-gray-800';
                },
                
                formatTimestamp(timestamp) {
                    return new Date(timestamp).toLocaleString();
                },
                
                getStartTime() {
                    if (!this.productionStatus.stats.start_time) return 'N/A';
                    return new Date(this.productionStatus.stats.start_time).toLocaleString();
                },
                
                getLastProcessed() {
                    if (!this.productionStatus.stats.last_processed) return 'N/A';
                    return new Date(this.productionStatus.stats.last_processed).toLocaleString();
                },
                
                getUptime() {
                    if (!this.productionStatus.stats.start_time) return 'N/A';
                    const start = new Date(this.productionStatus.stats.start_time);
                    const now = new Date();
                    const diff = now - start;
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    return `${hours}h ${minutes}m`;
                }
            }
        }
    </script>
</body>
</html> 